<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <style type="text/css">
            .noSelect
            {
	            -moz-user-select: none; 
                -khtml-user-select: none; 
                -webkit-user-select: none; 
                -o-user-select: none;
            }

            .noDrag
            {
	            user-drag: none;
	            -moz-user-select: none;
	            -webkit-user-drag: none;
            }
        </style>
        
        <script type="text/javascript" src="../assets/graphics.js"></script>

        <script type="text/javascript" src="../core/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="../core/Barrett.js"></script>
        <script type="text/javascript" src="../core/BigInt.js"></script>
        <script type="text/javascript" src="../core/RSA.js"></script>
        <script type="text/javascript" src="../core/priority_queue.js"></script>
        <script type="text/javascript" src="../core/easing.js"></script>
        <script type="text/javascript" src="../core/constants.js"></script>
        <script type="text/javascript" src="../core/entitysystem.js"></script>
        <script type="text/javascript" src="../core/components.js"></script>        
        <script type="text/javascript" src="../core/systems.js"></script>
        <script type="text/javascript" src="../core/utils.js"></script>
        <script type="text/javascript" src="../core/pfx.js"></script>
        <script type="text/javascript" src="../core/resources.js"></script>
        <script type="text/javascript" src="../core/seedrandom.js"></script>
        
        <script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
        <script type="text/javascript" src="webgl.js"></script>
        
        <script type="text/javascript" >
            /**
            * request animation frame convenience
            * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
            */
            window.requestAnimFrame = (function () {
                return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
                function (callback) {
                    var timeFrame = 1000 / 60;
                    window.setTimeout(function () { callback(+new Date); }, timeFrame);
                };
            })();            
        </script>
        <!--<script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            uniform bool uUseTextures;

            uniform sampler2D uSampler;
            //uniform float uAlpha;

            varying vec4 vColor;
            varying vec2 vTextureCoord;            

            void main(void) {                
                if (!uUseTextures) {
                    gl_FragColor = vColor;
                }
                else {
                    //vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                    //gl_FragColor = textureColor;// * vColor;                    
                    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                    //gl_fragColor = vec4(textureColor.rgb, textureColor.as * uAlpha);
                }
            }
        </script>

        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec2 aTextureCoord;
            attribute vec4 aVertexColor;                 

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;

            varying vec4 vColor;
            varying vec2 vTextureCoord;

            void main(void) {
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);                
                vColor = aVertexColor;
                vTextureCoord = aTextureCoord;
            }
        </script>-->

        <!--<script id="tex-shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;

            uniform sampler2D uSampler;

            void main(void) {
                gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
            }
        </script>

        <script id="tex-shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec2 aTextureCoord;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;

            varying vec2 vTextureCoord;

            void main(void) {
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                vTextureCoord = aTextureCoord;
            }
        </script>-->
    </head>
    <body>
        <div id="mydiv">
            <canvas id="mycanvas" width="800" height="600" class="noDrag noSelect"></canvas>
        </div>
        <input type="radio" name="rtype" value="WebGLRenderSystem" />Web GL
        <input type="radio" name="rtype" value="RenderSystem" checked />2d Canvas
        <input type="text" value="100" /><input type="button" value="update" />
        <div>FPS:<span id="fps">0</span></div>
        
        <script type="text/javascript">
            var renderSystemName = 'RenderSystem';

            var canvas = $('#mycanvas')[0];
            $(canvas).attr('unselectable', 'on')
                     .css('user-select', 'none')
                     .on('selectstart', false);

            var em = boc.core.Entity_internal.em();

            var camera = new boc.utils.Camera({ xmin: 0, ymin: 0, xmax: canvas.width, ymax: canvas.height });
            var renderSystem = new boc.systems[renderSystemName](em, canvas, camera);//.WebGLRenderSystem(em, canvas, camera);
            //var renderSystem = new boc.systems.RenderSystem(em, canvas);
            //renderSystem.camera(camera);
            var spriteAnimationSystem = new boc.systems.SpriteAnimationSystem(em);
            var mouseInputSystem = new boc.systems.MouseInputSystem(em, canvas);
            var panningCameraSystem = new boc.systems.PanningCameraSystem(em, camera);

            $('input[name="rtype"]').each(function () {
                $(this).change(function () {
                    //if ($(this).attr('checked')) {
                    renderSystemName = $(this).val();                    
                    //console.log(renderSystemName);
                    //}                     
                })
            });

            boc.resources.GraphicsManager.loadFiles(
                ['spearWarrior_walk_atlas.png']
            );

            boc.resources.GraphicsManager.load(bbq.assets.graphics,
                function () {
                    var lastFrame = 0;
                    var stop = false;

                    var fps = 0;
                    var iter = 0;
                    

                    function loop(now) {
                        if (stop) { return; }
                        //var sw = new boc.utils.Stopwatch();
                        requestAnimFrame(loop);
                        var frameTime = now - lastFrame;
                        //sw.start();
                        mouseInputSystem.processTick(frameTime);
                        panningCameraSystem.processTick(frameTime);
                        spriteAnimationSystem.processTick(frameTime);
                        renderSystem.processTick(frameTime);

                        var fps = 1000 / (now - lastFrame);

                        lastFrame = now;
                        //sw.stop();
                        if (iter++ % 2 == 0) {
                            $('#fps').text(fps.toFixed(1));
                        }
                    } // loop

                    loop(lastFrame);


                    function createWalker(x, y, team) {
                        var walker = $em.create();
                        $em(walker)
                            //.add(new boc.components.Spatial({ x: x, y: y, z: 0.0, width: 50, height: 50 }))
                            .add(new boc.components.Spatial({ x: x, y: y, z: 0.0, width: 50, height: 50 }))
                            //.add(new boc.components.DrawableRect({ fillStyle: 'red' }));
                        //.add(new boc.components.DrawableSprite({ image: boc.resources.GraphicsManager.getImage('assets/Units/SpearWarrior/'+team+'/Walk/SpearWarrior_Walk0001.png') }));
                            .add(new boc.components.DrawableSprite({ image: boc.resources.GraphicsManager.getImage('spearWarrior_walk_atlas.png'), clipRect: { x: 0, y: 0, width: 50, height: 50 } }));

                        //var sprites = [];
                        //for (var i = 1; i <= 8; i++) {
                        //    sprites.push(new boc.components.DrawableSprite({ image: boc.resources.GraphicsManager.getImage('assets/Units/SpearWarrior/' + team + '/Walk/SpearWarrior_Walk000' + i + '.png') }));
                        //}

                        //var anim = new boc.utils.SpriteAnimationSequence({
                        //    entity: walker,
                        //    entityManager: em,
                        //    loop: true,
                        //    animations: [
                        //        new boc.components.SpriteAnimation({
                        //            easing: 'linearTween',
                        //            duration: 500,
                        //            sprites: sprites,
                        //            state: boc.constants.ANIMATION_PLAYING
                        //        })
                        //    ]
                        //}).start();                        

                        var atlasTable = [
                            [0, 0, 50, 50],
                            [50, 0, 50, 50],
                            [100, 0, 50, 50],
                            [150, 0, 50, 50],
                            [200, 0, 50, 50],

                            [0, 50, 50, 50],
                            [50, 50, 50, 50],
                            [100, 50, 50, 50]
                        ]

                        var sprites = [];
                        for (var i = 1; i <= 8; i++) {
                            sprites.push(
                                new boc.components.DrawableSprite({
                                    image: boc.resources.GraphicsManager.getImage('spearWarrior_walk_atlas.png'),
                                    clipRect: {
                                        x: atlasTable[i - 1][0],
                                        y: atlasTable[i - 1][1],
                                        width: atlasTable[i - 1][2],
                                        height: atlasTable[i - 1][3]
                                    }
                                }));
                        }

                        var anim = new boc.utils.SpriteAnimationSequence({
                            entity: walker,
                            entityManager: em,
                            loop: true,
                            animations: [
                                new boc.components.SpriteAnimation({
                                    easing: 'linearTween',
                                    duration: 500,
                                    sprites: sprites,
                                    state: boc.constants.ANIMATION_PLAYING
                                })
                            ]
                        }).start();
                    }

                    var teams = ['Red', 'Blue', 'Yellow'];
                    $('input[type="button"]').click(function () {
                        $em().clear();
                        Math.seedrandom(1);
                        for (var i = 0; i < +$('input[type="text"]').val() ; i++) {
                            createWalker(Math.floor(Math._random() * canvas.width), Math.floor(Math._random() * canvas.height), teams[i % 3]);
                        }
                        //createWalker(Math.floor(Math.random() * canvas.width), Math.floor(Math.random() * canvas.height), teams[0]);

                        $em($em.create())
                            .add(new boc.components.Spatial({ x: 0, y: 0, width: canvas.width, height: canvas.height, z: -1 }))
                            .add(new boc.components.DrawableRect({ fillStyle: 'white' }));

                        

                        if (renderSystemName == 'RenderSystem') {
                            $em('Spatial').each(function (e, c) {
                                if ($em(e).comp('DrawableRect')) { return; }
                                //c.update({ width: 50, height: 50 });
                                if ($em(e).comp('WebGLDrawable')) {
                                    $em(e).remove('WebGLDrawable');
                                }
                            });
                        }
                        else {
                            $em('Spatial').each(function (e, c) {
                                if ($em(e).comp('DrawableRect')) { return; }
                                //c.update({ width: 64, height: 64 });
                            });
                        }
                        $('canvas').remove();
                        canvas = document.createElement('canvas');
                        canvas.width = 800;
                        canvas.height = 600;
                        $(canvas).attr('unselectable', 'on')
                            .css('user-select', 'none')
                            .on('selectstart', false);
                        $('#mydiv').append(canvas);
                        renderSystem = new boc.systems[renderSystemName](em, canvas, camera);
                        mouseInputSystem = new boc.systems.MouseInputSystem(em, canvas);
                    });
                } // onLoad
            ); //load
       
            
        </script>
    </body>
</html>