<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <!--<meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=no"/>
    <style type="text/css">
        canvas { -webkit-transform: scale3d(2, 2, 0) translate3d(200px, 110px, 0); }
    </style>-->
    <title>boc spine</title>
    
    
    <script type="text/javascript" src="./assets/Spine/skeletons.js"></script>
    <script type="text/javascript" src="./core/jquery-2.0.2.min.js"></script>
    <script type="text/javascript" src="./core/entitysystem.js"></script>
    <script type="text/javascript" src="./core/seedrandom.js"></script>
    <script type="text/javascript" src="./core/easing.js"></script>
    <script type="text/javascript" src="./core/constants.js"></script>
    <script type="text/javascript" src="./core/components.js"></script>
    <script type="text/javascript" src="./core/systems.js"></script>
    <script type="text/javascript" src="./core/utils.js"></script>
    <script type="text/javascript" src="./core/resources.js"></script>
    <script type="text/javascript" src="./bbq/game.js"></script>
    <script type="text/javascript" src="./bbq/tiles.js"></script>
    <script type="text/javascript" src="./bbq/components.js"></script>
    <script type="text/javascript" src="./bbq/map.js"></script>    
    <script type="text/javascript" src="./bbq/algorithms.js"></script>    
    <script type="text/javascript" src="./bbq/gamedata.js"></script>
    <script type="text/javascript" src="./assets/graphics.js"></script>
    <script type="text/javascript" src="./spine.js"></script>    
    <script type="text/javascript" src="./bocSpine.js"></script>       
    <script type="text/javascript">
        /**
           * request animation frame convenience
           * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
           */
        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
            function (callback) {
                var timeFrame = 1000 / 60;
                window.setTimeout(function () { callback(+new Date); }, timeFrame);
            };
        })();
    </script>
</head>
<body>
    <canvas id="mycanvas" width="600" height="400"></canvas>
    <div>Click on the canvas</div>
    <div id="number">0</div>
    <div>FPS:<span id="fps">0</span></div>
    <form id="animForm">
        <input type="radio" name="anim" value="walk" checked="checked" />walk
        <input type="radio" name="anim" value="jump" />jump
        <input type="radio" name="anim" value="none" />none
    </form>

    <script type="text/javascript">      
        var canvas = document.getElementById('mycanvas');//$('#mycanvas')[0];
        var context = canvas.getContext('2d');
        var stop = false;
        var numSpineBoys = 0;
        function onGraphicsLoaded() {

            var map = new bbq.Map('testmap', $em(),
                {
                    //'padding-left': camera.width() / 2, //p.canvas.width / 2,
                    //'padding-right': camera.width() / 2,//p.canvas.width / 2,
                    //'padding-top': camera.height() / 2,//p.canvas.height / 2,
                    //'padding-bottom': camera.height() / 2//p.canvas.height / 2
                    'padding-left': canvas.width / 2,
                    'padding-right': canvas.width / 2,
                    'padding-top': canvas.height / 2,
                    'padding-bottom': canvas.height / 2
                }
            );

            var camera = new boc.utils.Camera({
                xmin: 0,
                xmax: canvas.width,
                ymin: 0,
                ymax: canvas.height
            });
            var renderSystem = new boc.systems.RenderSystem($em(), canvas, camera);
            var panningCameraSystem = new boc.systems.PanningCameraSystem($em(), renderSystem.camera());
            var mouseInputSystem = new boc.systems.MouseInputSystem($em(), canvas);
            var spriteAnimationSystem = new boc.systems.SpriteAnimationSystem($em());
            var animationSystem = new boc.spine.SpineAnimationSystem();
            var lifespanSystem = new boc.systems.LifespanSystem($em());
            $em($em.create('bg'))
                    .ns('boc.components')
                        .add('Spatial', { x: 0, y: 0, z: -1, width: $('#mycanvas').width(), height: $('#mycanvas').height() })
                        .add('DrawableRect', { fillStyle: 'white' });


            function createSpineBoy(x, y) {
                $('#number').text(++numSpineBoys);
                var spineBoy = $em.create('spineBoy');

                $em(spineBoy)
                    .add(new boc.components.Spatial({ x: x, y: y, z : 10000, width: 50, height: 50, scale: 0.5 }))
                    .add(new boc.spine.SpineDrawable({ visible: true, skeleton: boc.spine.SkeletonManager.createSkeleton('spearWarrior') }));

                
                var anim = $("#animForm input[type='radio']:checked").val();
                if (anim == 'walk' || anim == 'jump') {
                    var spineBoyAnimation = new boc.spine.SpineAnimation({
                        state: boc.constants.ANIMATION_PLAYING,
                        target: spineBoy
                    });
                    $em(spineBoy).add(spineBoyAnimation);
                    spineBoyAnimation.animationState.setAnimationByName(anim == 'walk' ? 'Walk' : 'Idle', true);
                }
            }
            
            //canvas.onmouseup = function (e) {
            //    createSpineBoy(e.clientX, e.clientY);
            //}
            canvas.addEventListener('mouseup', function (e) {
                createSpineBoy(e.clientX + camera.xmin, e.clientY + camera.ymin);
            }, false);

            var lastFrame = 0;
            var iter = 0;
            function loop(now) {
                if (stop) {
                    return;
                }
                requestAnimFrame(loop);
                var frameTime = now - lastFrame;
                
                if (iter++ % 2 == 0) {
                    var fps = 1000 / (now - lastFrame);
                    $('#fps').text(fps.toFixed(1));
                }
                mouseInputSystem.processTick(frameTime);
                panningCameraSystem.processTick(frameTime);
                animationSystem.processTick(frameTime);
                spriteAnimationSystem.processTick(frameTime);
                renderSystem.processTick(frameTime);
                lifespanSystem.processTick(frameTime);
                lastFrame = now;
                
            } // loop
            loop(lastFrame);
        }
        boc.resources.GraphicsManager.load(bbq.assets.graphics, function () {
            boc.resources.GraphicsManager.loadFiles(
                [
                    'assets/Spine/spineboy.png',
                    'assets/Spine/SpearWarrior.png'
                ],
                onGraphicsLoaded
            );
        });
        boc.spine.SkeletonManager.load(assets.spine);
    </script>
</body>
</html>
